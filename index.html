import { useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";

// å‚»æ¯”åé€£æŠ½å¡æ± ï¼ˆå–®æª” React Componentï¼‰
// ä½¿ç”¨æ–¹å¼ï¼šé€™æª”æ¡ˆå¯ç›´æ¥åœ¨ ChatGPT Canvas é è¦½ï¼Œæˆ–è¤‡è£½åˆ°ä½ çš„ React å°ˆæ¡ˆä¸­ã€‚
// éœ€è¦ï¼šTailwindï¼ˆCanvas å…§å»ºï¼‰èˆ‡ framer-motionï¼ˆCanvas å¯ç”¨ï¼‰ã€‚

const CARD_POOL: Record<string, string[]> = {
  "å¯æ„›å¡ ğŸ¾": [
    "å–µï½å¿«æŠ±æˆ‘ï¼Œä¸ç„¶æˆ‘è¦æ»¾åœ°æ¿äº†ï¼",
    "è‚‰çƒåªçµ¦ä½ æ‘¸å–µï¼",
    "ä»Šå¤©çš„å¯æ„›é…é¡åªçµ¦ä½ ï¼",
    "é éä¾†ï¼Œè®“æˆ‘ç”¨å°è…¦è¢‹æ‹±ä½ ä¸€ä¸‹ï½",
    "æœ¬å–µä»Šå¤©ä¹Ÿè¦æŠŠä½ å ç‚ºå·±æœ‰ âœ§"
  ],
  "æ²™é›•å¡ ğŸ¤£": [
    "æˆ‘ä¸æ˜¯å‚»ï¼Œæˆ‘åªæ˜¯å¿«æ¨‚éé‡ã€‚",
    "äººå®¶åªæ˜¯è‚šå­åœ¨ä¿®ç…‰ï¼Œä¸æ˜¯èƒ–ï¼",
    "ä½ è¦æ˜¯ä¸ç¬‘ï¼Œæˆ‘å°±è£æ­»çµ¦ä½ çœ‹ (x_x)",
    "ä»Šå¤©ä¸æç¬‘èº«é«”æœƒç¼ºéˆ£ï¼",
    "æˆ‘åœ¨ç¯€é£Ÿâ€”â€”ç¯€çš„æ˜¯ç†æ™ºé£Ÿã€‚"
  ],
  "ä¸­äºŒå¡ âš¡": [
    "é»‘æš—åœ¨å‘¼å–šï¼Œè€Œæˆ‘å›æ‡‰äº†å®ƒã€‚",
    "æ˜Ÿè¾°çš†å¢œè½ï¼Œå”¯æˆ‘ä»ç‹‚èˆï¼",
    "ä¸–ç•Œçš„ç›¡é ­ï¼Œåˆ»è‘—å‚»æ¯”çš„åå­—ã€‚",
    "é¢¨æš´å› æˆ‘è€Œç”Ÿï¼Œå¯‚éœç‚ºæˆ‘è®“é“ã€‚",
    "å…‰èˆ‡å½±çš„ç•Œç·šï¼Œå³æ˜¯æˆ‘çš„ç–†åŸŸã€‚"
  ],
  "é©šå–œå¡ ğŸŒˆ": [
    "ä»Šå¤©æœƒæœ‰å¥½é‹é™è‡¨ï¼Œå› ç‚ºä½ æŠ½åˆ°æˆ‘å•¦ï½",
    "ç§˜å¯†å¡ï¼šå¿«å»å–æ°´ï¼",
    "éš±è—Bosså¡ï¼šå‚»æ¯”è¶…é€²åŒ–ï¼",
    "åŠ åˆ†å¡ï¼šç¾åœ¨å»å‚³è¨Šæ¯çµ¦ä¸€å€‹æœ‹å‹ï½",
    "ä¼‘æ¯å¡ï¼šä¼¸å€‹æ‡¶è…°å†æŠ½ä¸€æ¬¡ï¼"
  ]
};

const CATEGORIES = Object.keys(CARD_POOL);

function drawTen(): { category: string; text: string; id: string }[] {
  const results: { category: string; text: string; id: string }[] = [];
  // ä¿åº•ï¼šå¯æ„›ã€æ²™é›•ã€ä¸­äºŒå„ä¸€
  ["å¯æ„›å¡ ğŸ¾", "æ²™é›•å¡ ğŸ¤£", "ä¸­äºŒå¡ âš¡"].forEach((key) => {
    const text = randomPick(CARD_POOL[key]);
    results.push({ category: key, text, id: cryptoId() });
  });
  // å…¶é¤˜éš¨æ©Ÿè£œæ»¿åˆ° 10 å¼µ
  while (results.length < 10) {
    const cat = randomPick(CATEGORIES);
    const text = randomPick(CARD_POOL[cat]);
    results.push({ category: cat, text, id: cryptoId() });
  }
  return results;
}

function randomPick<T>(arr: T[]): T {
  return arr[Math.floor(Math.random() * arr.length)];
}

function cryptoId() {
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}

export default function SabiiGacha() {
  const [results, setResults] = useState<ReturnType<typeof drawTen> | null>(null);
  const [rolling, setRolling] = useState(false);
  const [revealed, setRevealed] = useState(false);

  const counts = useMemo(() => {
    const map: Record<string, number> = {};
    CATEGORIES.forEach((c) => (map[c] = 0));
    results?.forEach((r) => (map[r.category]++));
    return map;
  }, [results]);

  const handleRoll = async () => {
    setRolling(true);
    setRevealed(false);
    setResults(drawTen());
    // æ¨¡æ“¬ç¿»ç‰Œå‹•ç•«æ™‚é–“
    await new Promise((r) => setTimeout(r, 1200));
    setRevealed(true);
    setRolling(false);
  };

  const handleCopy = async () => {
    if (!results) return;
    const lines = results.map((r, i) => `${i + 1}. ${r.category}ï¼š${r.text}`).join("\n");
    try {
      await navigator.clipboard.writeText(`ğŸ° å‚»æ¯”åé€£æŠ½çµæœ\n${lines}`);
      alert("å·²è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿ï¼");
    } catch (e) {
      alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ã€‚");
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900 p-6">
      <div className="max-w-3xl mx-auto">
        <header className="text-center mb-6">
          <h1 className="text-3xl md:text-4xl font-extrabold tracking-tight">ğŸ° å‚»æ¯”åé€£æŠ½å¡æ± </h1>
          <p className="text-slate-600 mt-2">ä¸€æ¬¡åæŠ½ï¼Œä¿åº•å¯æ„›ï¼‹æ²™é›•ï¼‹ä¸­äºŒå„ä¸€å¼µï¼</p>
        </header>

        <div className="flex flex-col sm:flex-row gap-3 justify-center mb-6">
          <button
            onClick={handleRoll}
            disabled={rolling}
            className="px-5 py-3 rounded-2xl shadow bg-black text-white disabled:opacity-60"
          >
            {rolling ? "æŠ½å¡ä¸­â€¦" : results ? "å†æŠ½åé€£" : "é–‹å§‹åé€£æŠ½"}
          </button>
          <button
            onClick={handleCopy}
            className="px-5 py-3 rounded-2xl shadow border border-slate-300 bg-white"
          >
            è¤‡è£½çµæœ
          </button>
        </div>

        {/* å¡ç‰Œå€ */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
          {results ? (
            results.map((card, idx) => (
              <CardFlip key={card.id} index={idx} revealed={revealed}>
                <CardFace category={card.category} text={card.text} />
              </CardFlip>
            ))
          ) : (
            <div className="col-span-full text-center text-slate-500">
              æŒ‰ä¸‹ã€Œé–‹å§‹åé€£æŠ½ã€ï¼Œè®“å‘½é‹ç¿»ç‰Œ âœ¨
            </div>
          )}
        </div>

        {/* çµ±è¨ˆ */}
        {results && (
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            className="mt-8 bg-white rounded-2xl shadow p-4"
          >
            <h2 className="font-bold text-lg mb-2">çµæœçµ±è¨ˆ</h2>
            <ul className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
              {CATEGORIES.map((c) => (
                <li key={c} className="flex items-center justify-between border rounded-xl px-3 py-2">
                  <span>{c}</span>
                  <span className="font-mono">{counts[c] ?? 0}</span>
                </li>
              ))}
            </ul>
          </motion.div>
        )}

        <footer className="text-center text-xs text-slate-500 mt-8">
          Made for å‚»æ¯” Â· é€™æ˜¯ä½ çš„å°ˆå±¬å¡æ±  âœ¨
        </footer>
      </div>
    </div>
  );
}

function CardFlip({ children, index, revealed }: { children: React.ReactNode; index: number; revealed: boolean }) {
  return (
    <motion.div
      className="aspect-[3/4] bg-white rounded-2xl shadow relative overflow-hidden"
      initial={{ rotateY: 0 }}
      animate={{ rotateY: revealed ? 180 : 0 }}
      transition={{ duration: 0.6, delay: index * 0.05 }}
      style={{ transformStyle: "preserve-3d" }}
    >
      {/* èƒŒé¢ï¼ˆæœªæ­ç¤ºï¼‰ */}
      <div
        className="absolute inset-0 grid place-items-center bg-gradient-to-br from-slate-800 to-slate-900 text-white"
        style={{ backfaceVisibility: "hidden" }}
      >
        <motion.div
          animate={{ scale: revealed ? 0.9 : [1, 1.05, 1] }}
          transition={{ duration: 1.2, repeat: revealed ? 0 : Infinity, repeatType: "reverse" }}
          className="text-2xl font-black tracking-widest"
        >
          S A B I I
        </motion.div>
      </div>
      {/* æ­£é¢ï¼ˆæ­ç¤ºå¾Œï¼‰ */}
      <div
        className="absolute inset-0 p-3 flex flex-col"
        style={{ backfaceVisibility: "hidden", transform: "rotateY(180deg)" }}
      >
        {children}
      </div>
    </motion.div>
  );
}

function CardFace({ category, text }: { category: string; text: string }) {
  const badge = category.includes("å¯æ„›")
    ? "bg-pink-100 text-pink-700"
    : category.includes("æ²™é›•")
    ? "bg-yellow-100 text-yellow-700"
    : category.includes("ä¸­äºŒ")
    ? "bg-purple-100 text-purple-700"
    : "bg-emerald-100 text-emerald-700";

  return (
    <div className="flex flex-col h-full">
      <div className={`px-2 py-1 rounded-xl text-xs font-semibold w-max ${badge}`}>{category}</div>
      <div className="mt-2 text-base leading-relaxed flex-1">{text}</div>
      <div className="mt-3 text-xs text-slate-400">#å‚»æ¯”å¡æ± </div>
    </div>
  );
}
